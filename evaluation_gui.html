<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Evaluation Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .instructions {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .color-guide {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .color-guide span {
            font-weight: bold;
        }

        .green { color: darkgreen; }
        .blue { color: royalblue; }
        .red { color: red; }

        .main-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .question-header {
            margin-bottom: 30px;
        }

        .question-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.2rem;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .column {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
        }

        .column h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .fact-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .fact-checkbox {
            margin-right: 15px;
            margin-top: 3px;
        }

        .fact-text {
            flex: 1;
            font-size: 1rem;
        }

        .not-mentioned-btn {
            padding: 6px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 15px;
        }

        .not-mentioned-btn:hover {
            background: #545b62;
        }

        .not-mentioned-btn.active {
            background: #dc3545;
        }

        .not-mentioned-btn.active:hover {
            background: #c82333;
        }

        .relevance-accurate {
            margin-left: 15px;
            display: flex;
            align-items: center;
        }

        .relevance-accurate label {
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .evaluation-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            align-items: start;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            transition: opacity 0.3s ease, filter 0.3s ease;
        }

        .fact-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .not-mentioned-inside {
            margin-top: 2px;
            margin-left: 25px;
        }

        .not-mentioned-inside label {
            font-size: 0.85rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
        }

        .evaluation-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .correctness-container {
            margin-bottom: 20px;
        }

        .not-mentioned-outside {
            margin-top: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .not-mentioned-outside label {
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
        }

        .evaluation-row.faded {
            opacity: 0.4;
            filter: grayscale(50%);
        }

        .evaluation-row.faded .fact-checkbox {
            pointer-events: none;
        }

        .evaluation-row.faded .not-mentioned-btn {
            pointer-events: auto;
        }

        .evaluation-row.faded .not-mentioned-inside {
            pointer-events: auto;
        }

        .evaluation-row.faded .not-mentioned-inside input[type="checkbox"] {
            pointer-events: auto;
        }

        .not-mentioned-section {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .not-mentioned-section label {
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .checkbox-group label {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }

        .sidebar {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .expandable {
            margin-bottom: 15px;
        }

        .expandable-header {
            background: #e9ecef;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expandable-content {
            padding: 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            display: none;
        }

        .expandable-content.show {
            display: block;
        }

        .divider {
            height: 2px;
            background: #dee2e6;
            margin: 30px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .thank-you-page {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 20px 0;
            display: none;
        }

        .thank-you-page h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .thank-you-page h2 {
            font-size: 1.8rem;
            margin-bottom: 30px;
            font-weight: 400;
            opacity: 0.9;
        }

        .thank-you-page p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.8;
            line-height: 1.6;
        }

        .evaluation-id {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .restart-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .restart-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                width: 100%;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .evaluation-row {
                grid-template-columns: 1fr;
            }
            
            .evaluation-options {
                grid-template-columns: 1fr;
            }
        }

        .fact-item.faded {
            opacity: 0.4;
            filter: grayscale(50%);
        }

        .fact-item.faded .fact-checkbox {
            pointer-events: none;
        }

        .fact-item.faded .not-mentioned-btn {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Question Answering Evaluation!!</h1>
        </div>

        <div class="instructions">
            <h3>Welcome to the AI Answer Evaluation Tool!</h3>
            <p>This tool breaks down evaluation into three steps:</p>
            <ul>
                <li><strong>Key Fact Coverage (completeness and risk awareness):</strong> Evaluate which ground truth key facts are covered by the AI assistant's response</li>
                <li><strong>Key Fact Correctness:</strong> Assess whether the AI assistant's stated facts are accurate, inaccurate, or not mentioned</li>
                <li><strong>Relevance and Actionability:</strong> Determine which facts are relevant to the question and whether the overall response is actionable</li>
            </ul>
        </div>

        <div class="main-content" id="mainContent">
            <!-- Content will be dynamically generated -->
        </div>

        <div class="thank-you-page" id="thankYouPage">
            <h1>🎉 Thank You!</h1>
            <h2>Your evaluation has been completed successfully</h2>
            <p>Thank you for taking the time to evaluate the AI assistant responses. Your feedback is invaluable for improving the quality of AI-generated answers.</p>
            
            <div class="evaluation-id" id="evaluationIdDisplay">
                Evaluation ID: <span id="evaluationIdSpan"></span>
            </div>
            
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated dynamically -->
            </div>
            
            <button class="restart-btn" onclick="restartEvaluation()">Start New Evaluation</button>
        </div>

        <div class="success-message" id="successMessage">
            Results successfully saved!
        </div>

        <div class="error-message" id="errorMessage">
            Error loading data. Please check the file paths and try again.
        </div>
    </div>

    <div class="sidebar">
        <h3>Navigation</h3>
        <div class="nav-buttons">
            <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">⬅️ Previous</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Next ➡️</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Question 1 of 1</div>
        
        <button class="btn btn-primary" style="width: 100%;" onclick="finishAndSave()">Finish and Save Results</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBVQx7l8alDEWRW9qpxAPrgXiSeNtc6NHc",
          authDomain: "ai-evaluation-82fc8.firebaseapp.com",
          projectId: "ai-evaluation-82fc8",
          storageBucket: "ai-evaluation-82fc8.appspot.com",
          messagingSenderId: "5824392171",
          appId: "1:5824392171:web:dbe5090e30248c5e1547ae",
          measurementId: "G-HR0NVE9J9L"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Try to sign in anonymously, but don't block the app if it fails
        auth.signInAnonymously()
            .then(() => {
                console.log('Signed in anonymously to Firebase');
                // Test Firebase connectivity
                testFirebaseConnection();
            })
            .catch((error) => {
                console.error('Error signing in anonymously:', error);
                console.log('Continuing without Firebase authentication - some features may be limited');
            });

        function testFirebaseConnection() {
            console.log('Testing Firebase connection...');
            // Try to read from a test document
            db.collection('test').doc('connection-test').get()
                .then((doc) => {
                    console.log('Firebase read test successful');
                })
                .catch((error) => {
                    console.error('Firebase read test failed:', error);
                    console.log('This might indicate Firestore security rules are blocking access');
                });
        }

        // Global state
        let questions = [];
        let currentIndex = 0;
        let currentStep = 1; // Track current step (1, 2, or 3)
        let results = {};

        // Configuration
        const MANUAL_FILE = 'key points/manual_answer_key_facts.json';
        const MODEL_FILE = 'key points/model_answer_key_facts_gemini_rag.json';
        const OUTPUT_FILE = 'evaluation_results.json';
        const SAMPLE_FRACTION = 0.01;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadAndPrepareData();
        });

        function loadAndPrepareData() {
            // Try to load data from JSON files and sample 10%
            Promise.all([
                fetch(MANUAL_FILE),
                fetch(MODEL_FILE)
            ])
            .then(responses => {
                // Check if responses are ok
                if (!responses[0].ok || !responses[1].ok) {
                    throw new Error('Files not found or not accessible');
                }
                return Promise.all(responses.map(r => r.json()));
            })
            .then(([manualData, modelData]) => {
                // Combine and sample 10% of the data
                questions = sampleQuestions(manualData, modelData, SAMPLE_FRACTION);
                updateUI();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                console.log('Falling back to sample data due to CORS restrictions or file access issues.');
                console.log('To use real data, serve this HTML file through a local web server.');
                
                // Fallback to sample data
                questions = createSampleData();
                updateUI();
                
                // Show info message instead of error
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = 'Using sample data. To load real data, serve this file through a local web server (e.g., python -m http.server).';
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d1ecf1';
                errorDiv.style.color = '#0c5460';
            });
        }

        function createSampleData() {
            // Sample data structure for fallback
            return [
                {
                    id: "q1",
                    question: "How do I charge my Tesla vehicle?",
                    manual_answer: "To charge your Tesla vehicle, you can use a Supercharger, home charging station, or standard electrical outlet. The charging time varies based on the method used.",
                    model_answer: "You can charge your Tesla using Superchargers, home chargers, or standard outlets. Superchargers provide the fastest charging.",
                    key_facts_manual: {
                        essential: [
                            "Use Supercharger for fast charging",
                            "Home charging station available",
                            "Standard electrical outlet compatible"
                        ],
                        optional: [
                            "Charging time varies by method",
                            "Mobile app can monitor charging"
                        ],
                        safety_critical: [
                            "Follow safety guidelines when charging"
                        ]
                    },
                    key_facts_model: {
                        essential: [
                            "Superchargers provide fastest charging",
                            "Home chargers available",
                            "Standard outlets can be used"
                        ],
                        optional: [
                            "Charging speed varies",
                            "Multiple charging options exist"
                        ]
                    }
                },
                {
                    id: "q2",
                    question: "What should I do if my Tesla won't start?",
                    manual_answer: "If your Tesla won't start, check the battery level, ensure the key fob is present, and try rebooting the system. Contact Tesla support if issues persist.",
                    model_answer: "Check battery level and key fob. Try rebooting the system. Contact support if problems continue.",
                    key_facts_manual: {
                        essential: [
                            "Check battery level",
                            "Ensure key fob is present",
                            "Try rebooting the system"
                        ],
                        optional: [
                            "Contact Tesla support if issues persist",
                            "Check for error messages"
                        ],
                        safety_critical: [
                            "Do not attempt repairs yourself"
                        ]
                    },
                    key_facts_model: {
                        essential: [
                            "Check battery level",
                            "Ensure key fob is present",
                            "Try rebooting the system"
                        ],
                        optional: [
                            "Contact support if problems continue",
                            "Look for error indicators"
                        ]
                    }
                }
            ];
        }

        function sampleQuestions(manualData, modelData, sampleFraction) {
            // Get all question IDs
            const allQuestionIds = Object.keys(manualData);
            
            // Calculate how many questions to sample (10%)
            const totalQuestions = allQuestionIds.length;
            const sampleSize = Math.max(1, Math.floor(totalQuestions * sampleFraction));
            
            // Use a fixed seed for consistent sampling
            const fixedSeed = 42; // Fixed seed for reproducible results
            const shuffled = shuffleArrayWithSeed(allQuestionIds, fixedSeed);
            const sampledIds = shuffled.slice(0, sampleSize);
            
            console.log(`Sampled ${sampleSize} questions out of ${totalQuestions} total questions (${(sampleFraction * 100).toFixed(1)}%)`);
            console.log(`Using fixed seed: ${fixedSeed} for consistent selection`);
            
            // Create question objects from sampled data
            return sampledIds.map(id => {
                const manual = manualData[id];
                const model = modelData[id];
                
                return {
                    id: id,
                    question: manual.question || model.question || `Question ${id}`,
                    manual_answer: manual.answer || '',
                    model_answer: model.answer || '',
                    key_facts_manual: {
                        essential: manual.key_facts?.essential || [],
                        optional: manual.key_facts?.optional || [],
                        safety_critical: manual.key_facts?.safety_critical || []
                    },
                    key_facts_model: {
                        essential: model.key_facts?.essential || [],
                        optional: model.key_facts?.optional || []
                    }
                };
            });
        }

        function shuffleArrayWithSeed(array, seed) {
            // Simple seeded random number generator
            let m = 0x80000000;
            let a = 1103515245;
            let c = 12345;
            let state = seed ? seed : Math.floor(Math.random() * (m - 1));
            
            const random = () => {
                state = (a * state + c) % m;
                return state / (m - 1);
            };
            
            // Fisher-Yates shuffle with seeded random
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled;
        }

        function updateUI() {
            if (!questions || questions.length === 0) {
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            const currentQuestion = questions[currentIndex];
            const mainContent = document.getElementById('mainContent');
            
            let stepContent = '';
            
            if (currentStep === 1) {
                stepContent = `
                    <div class="question-header">
                        <h2>Question ${currentIndex + 1}/${questions.length} - Step 1/3</h2>
                    </div>

                    <!-- Step 1: Completeness -->
                    <div class="section">
                        <h3>Step 1: Evaluate Key Fact Coverage <span style="font-size: 0.8em; font-weight: normal;">(completeness and risk awareness)</span></h3>
                        <div class="question-text">${currentQuestion.question}</div>
                        
                        <div class="two-column">
                            <div class="column">
                                <div class="expandable">
                                    <div class="expandable-header" onclick="toggleExpandable('gtAnswer')">
                                        Show Full Ground Truth Answer
                                        <span>▼</span>
                                    </div>
                                    <div class="expandable-content" id="gtAnswer">
                                        ${currentQuestion.manual_answer}
                                    </div>
                                </div>
                                
                                <h4>Ground Truth Key Facts</h4>
                                <p><em>Check the box for each point covered by the AI.</em></p>
                                
                                <div id="gtEssentialFacts"></div>
                                <div id="gtOptionalFacts"></div>
                            </div>
                            
                            <div class="column">
                                <div class="expandable">
                                    <div class="expandable-header" onclick="toggleExpandable('modelAnswer')">
                                        Show Full Assistant Answer
                                        <span>▼</span>
                                    </div>
                                    <div class="expandable-content" id="modelAnswer">
                                        ${currentQuestion.model_answer}
                                    </div>
                                </div>
                                
                                <h4>AI Assistant's Key Facts (for reference)</h4>
                                <p><em>&nbsp;</em></p>
                                
                                <div id="modelEssentialFacts"></div>
                                <div id="modelOptionalFacts"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentStep === 2) {
                stepContent = `
                    <div class="question-header">
                        <h2>Question ${currentIndex + 1}/${questions.length} - Step 2/3</h2>
                    </div>

                    <!-- Step 2: Correctness -->
                    <div class="section">
                        <h3>Step 2: Evaluate Key Fact Correctness</h3>
                        <div class="question-text">${currentQuestion.question}</div>
                        
                        <div class="two-column">
                            <div class="column">
                                <h4>Ground Truth Key Facts (for reference)</h4>
                                <p><em>&nbsp;</em></p>
                                <div id="gtCorrectnessFacts"></div>
                            </div>
                            
                            <div class="column">
                                <h4>AI Assistant's Key Facts</h4>
                                <p><em>Check box if fact is correct, or click "Not Mentioned" if the fact was not stated in GT.</em></p>
                                <div id="modelCorrectnessFacts"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentStep === 3) {
                stepContent = `
                    <div class="question-header">
                        <h2>Question ${currentIndex + 1}/${questions.length} - Step 3/3</h2>
                    </div>

                    <!-- Step 3: Evaluate Relevance and Actionability -->
                    <div class="section">
                        <h3>Step 3: Evaluate Relevance and Actionability</h3>
                        <div class="question-text">${currentQuestion.question}</div>
                        
                        <div class="column">
                            <h4>Relevance Evaluation</h4>
                            <p><em>Check the box for each fact that is relevant to the question.</em></p>
                            <div id="relevanceFacts"></div>
                            
                            <div class="divider"></div>
                            
                            <h4>Actionability Evaluation</h4>
                            <p><em>Click the checkbox if the AI Assistant's key facts represent an actionable response.</em></p>
                            <div class="fact-item">
                                <input type="checkbox" id="actionability" class="fact-checkbox">
                                <label for="actionability" class="fact-text">The assistant response represents actionability (is actionable)</label>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            mainContent.innerHTML = stepContent;

            // Render the facts based on current step
            if (currentStep === 1) {
                renderGroundTruthFacts();
                renderModelFacts();
            } else if (currentStep === 2) {
                renderCorrectnessFacts();
            } else if (currentStep === 3) {
                renderRelevanceAndActionabilityFacts();
            }
            
            // Update navigation
            updateNavigation();
        }

        function renderGroundTruthFacts() {
            const currentQuestion = questions[currentIndex];
            
            // Essential facts
            const gtEssentialDiv = document.getElementById('gtEssentialFacts');
            gtEssentialDiv.innerHTML = currentQuestion.key_facts_manual.essential.map((fact, index) => `
                <div class="fact-item">
                    <input type="checkbox" id="gt_essential_${index}" class="fact-checkbox">
                    <div class="fact-text green">${index + 1}. ${fact}</div>
                </div>
            `).join('');

            // Optional facts
            const gtOptionalDiv = document.getElementById('gtOptionalFacts');
            gtOptionalDiv.innerHTML = currentQuestion.key_facts_manual.optional.map((fact, index) => `
                <div class="fact-item">
                    <input type="checkbox" id="gt_optional_${index}" class="fact-checkbox">
                    <div class="fact-text green">${index + 1}. ${fact}</div>
                </div>
            `).join('');
        }

        function renderModelFacts() {
            const currentQuestion = questions[currentIndex];
            
            // Essential facts
            const modelEssentialDiv = document.getElementById('modelEssentialFacts');
            modelEssentialDiv.innerHTML = currentQuestion.key_facts_model.essential.map((fact, index) => `
                <div class="fact-item">
                    <div class="fact-text green">${index + 1}. ${fact}</div>
                </div>
            `).join('');

            // Optional facts
            const modelOptionalDiv = document.getElementById('modelOptionalFacts');
            modelOptionalDiv.innerHTML = currentQuestion.key_facts_model.optional.map((fact, index) => `
                <div class="fact-item">
                    <div class="fact-text green">${index + 1}. ${fact}</div>
                </div>
            `).join('');
        }

        function renderCorrectnessFacts() {
            const currentQuestion = questions[currentIndex];
            
            // Ground truth facts for reference
            const gtCorrectnessDiv = document.getElementById('gtCorrectnessFacts');
            gtCorrectnessDiv.innerHTML = [
                ...currentQuestion.key_facts_manual.essential.map((fact, index) => `
                    <div class="fact-item">
                        <div class="fact-text green">${index + 1}. ${fact}</div>
                    </div>
                `),
                ...currentQuestion.key_facts_manual.optional.map((fact, index) => `
                    <div class="fact-item">
                        <div class="fact-text green">${index + 1}. ${fact}</div>
                    </div>
                `)
            ].join('');

            // Model facts with evaluation options using checkboxes
            const modelCorrectnessDiv = document.getElementById('modelCorrectnessFacts');
            modelCorrectnessDiv.innerHTML = [
                ...currentQuestion.key_facts_model.essential.map((fact, index) => `
                    <div class="fact-item" id="eval_row_essential_${index}">
                        <input type="checkbox" name="correctness_essential_${index}_correct" class="fact-checkbox" onchange="handleNotMentionedChange('essential', ${index})">
                        <div class="fact-text green">${index + 1}. ${fact}</div>
                        <button type="button" class="not-mentioned-btn" id="not_mentioned_btn_essential_${index}" onclick="toggleNotMentioned('essential', ${index})">
                            Not Mentioned
                        </button>
                        <input type="hidden" name="correctness_essential_${index}_not_mentioned" value="false">
                    </div>
                `),
                ...currentQuestion.key_facts_model.optional.map((fact, index) => `
                    <div class="fact-item" id="eval_row_optional_${index}">
                        <input type="checkbox" name="correctness_optional_${index}_correct" class="fact-checkbox" onchange="handleNotMentionedChange('optional', ${index})">
                        <div class="fact-text green">${index + 1}. ${fact}</div>
                        <button type="button" class="not-mentioned-btn" id="not_mentioned_btn_optional_${index}" onclick="toggleNotMentioned('optional', ${index})">
                            Not Mentioned
                        </button>
                        <input type="hidden" name="correctness_optional_${index}_not_mentioned" value="false">
                    </div>
                `)
            ].join('');
        }

        function renderRelevanceAndActionabilityFacts() {
            const currentQuestion = questions[currentIndex];
            
            const modelRelevanceDiv = document.getElementById('relevanceFacts');
            modelRelevanceDiv.innerHTML = [
                ...currentQuestion.key_facts_model.essential.map((fact, index) => `
                    <div class="fact-item">
                        <input type="checkbox" id="relevance_relevant_essential_${index}" class="fact-checkbox">
                        <div class="fact-text green">${index + 1}. ${fact}</div>
                    </div>
                `),
                ...currentQuestion.key_facts_model.optional.map((fact, index) => `
                    <div class="fact-item">
                        <input type="checkbox" id="relevance_relevant_optional_${index}" class="fact-checkbox">
                        <div class="fact-text green">${index + 1}. ${fact}</div>
                    </div>
                `)
            ].join('');
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const finishBtn = document.querySelector('button[onclick="finishAndSave()"]');

            // Handle step navigation
            if (currentStep === 1) {
                prevBtn.disabled = currentIndex === 0;
                nextBtn.textContent = 'Next Step ➡️';
            } else if (currentStep === 2) {
                prevBtn.disabled = false;
                prevBtn.textContent = '⬅️ Previous Step';
                nextBtn.textContent = 'Next Step ➡️';
            } else if (currentStep === 3) {
                prevBtn.disabled = false;
                prevBtn.textContent = '⬅️ Previous Step';
                if (currentIndex < questions.length - 1) {
                    nextBtn.textContent = 'Next Question ➡️';
                } else {
                    nextBtn.textContent = 'Finish ➡️';
                }
            }

            // Calculate progress based on current question and step
            const totalSteps = questions.length * 3;
            const currentProgress = (currentIndex * 3 + currentStep);
            const progress = (currentProgress / totalSteps) * 100;
            
            progressFill.style.width = progress + '%';
            progressText.textContent = `Question ${currentIndex + 1}/${questions.length} - Step ${currentStep}/3`;

            // Disable finish button until all questions are completed
            const allQuestionsCompleted = checkAllQuestionsCompleted();
            finishBtn.disabled = !allQuestionsCompleted;
        }

        function checkAllQuestionsCompleted() {
            // Check if all questions have been visited (at least started)
            for (let i = 0; i < questions.length; i++) {
                const qId = questions[i].id;
                if (!results[qId]) {
                    return false;
                }
            }
            return true;
        }

        function toggleExpandable(id) {
            const content = document.getElementById(id);
            const header = content.previousElementSibling;
            const arrow = header.querySelector('span');
            
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '▼' : '▶';
        }

        function saveCurrentState() {
            const currentQuestion = questions[currentIndex];
            const qId = currentQuestion.id;

            // Initialize results for this question if not exists
            if (!results[qId]) {
                results[qId] = {
                    question_id: qId,
                    question_text: currentQuestion.question,
                    total_essential_ground_truth: currentQuestion.key_facts_manual.essential.length,
                    total_optional_ground_truth: currentQuestion.key_facts_manual.optional.length,
                    total_safety_critical_ground_truth: currentQuestion.key_facts_manual.safety_critical.length,
                    total_essential_model: currentQuestion.key_facts_model.essential.length,
                    total_optional_model: currentQuestion.key_facts_model.optional.length
                };
            }

            // Collect data based on current step
            if (currentStep === 1) {
                // Collect completeness data
                const gtEssentialSelections = Array.from(document.querySelectorAll('#gtEssentialFacts input[type="checkbox"]'))
                    .map(cb => cb.checked ? 1 : 0);
                const gtOptionalSelections = Array.from(document.querySelectorAll('#gtOptionalFacts input[type="checkbox"]'))
                    .map(cb => cb.checked ? 1 : 0);

                results[qId].covered_essential_ground_truth = gtEssentialSelections.reduce((a, b) => a + b, 0);
                results[qId].covered_optional_ground_truth = gtOptionalSelections.reduce((a, b) => a + b, 0);
                results[qId].covered_safety_critical_ground_truth = 0; // Would need to implement safety critical logic

            } else if (currentStep === 2) {
                // Collect correctness data
                const essentialCorrectness = {};
                const optionalCorrectness = {};
                
                // Process essential facts correctness
                currentQuestion.key_facts_model.essential.forEach((fact, index) => {
                    const notMentionedValue = document.querySelector(`input[name="correctness_essential_${index}_not_mentioned"]`).value;
                    const isNotMentioned = notMentionedValue === 'true';
                    
                    if (isNotMentioned) {
                        essentialCorrectness[index] = 'Not Mentioned';
                    } else {
                        const correctChecked = document.querySelector(`input[name="correctness_essential_${index}_correct"]`).checked;
                        
                        if (correctChecked) essentialCorrectness[index] = 'Accurate';
                        else essentialCorrectness[index] = 'Inaccurate';
                    }
                });
                
                // Process optional facts correctness
                currentQuestion.key_facts_model.optional.forEach((fact, index) => {
                    const notMentionedValue = document.querySelector(`input[name="correctness_optional_${index}_not_mentioned"]`).value;
                    const isNotMentioned = notMentionedValue === 'true';
                    
                    if (isNotMentioned) {
                        optionalCorrectness[index] = 'Not Mentioned';
                    } else {
                        const correctChecked = document.querySelector(`input[name="correctness_optional_${index}_correct"]`).checked;
                        
                        if (correctChecked) optionalCorrectness[index] = 'Accurate';
                        else optionalCorrectness[index] = 'Inaccurate';
                    }
                });

                results[qId].accurate_essential_model = Object.values(essentialCorrectness).filter(v => v === 'Accurate').length;
                results[qId].inaccurate_essential_model = Object.values(essentialCorrectness).filter(v => v === 'Inaccurate').length;
                results[qId].not_mentioned_essential_model = Object.values(essentialCorrectness).filter(v => v === 'Not Mentioned').length;
                results[qId].accurate_optional_model = Object.values(optionalCorrectness).filter(v => v === 'Accurate').length;
                results[qId].inaccurate_optional_model = Object.values(optionalCorrectness).filter(v => v === 'Inaccurate').length;
                results[qId].not_mentioned_optional_model = Object.values(optionalCorrectness).filter(v => v === 'Not Mentioned').length;

            } else if (currentStep === 3) {
                // Collect relevance and actionability data
                const essentialRelevance = Array.from(document.querySelectorAll('#relevanceFacts input[id^="relevance_relevant_essential_"]'))
                    .map(cb => cb.checked ? 1 : 0);
                const optionalRelevance = Array.from(document.querySelectorAll('#relevanceFacts input[id^="relevance_relevant_optional_"]'))
                    .map(cb => cb.checked ? 1 : 0);
                const isActionable = document.getElementById('actionability').checked;

                results[qId].relevant_essential_model = essentialRelevance.reduce((a, b) => a + b, 0);
                results[qId].relevant_optional_model = optionalRelevance.reduce((a, b) => a + b, 0);
                results[qId].is_actionable = isActionable;
            }
        }

        function previousQuestion() {
            saveCurrentState();
            
            if (currentStep > 1) {
                // Go to previous step
                currentStep--;
            } else if (currentIndex > 0) {
                // Go to previous question, last step
                currentIndex--;
                currentStep = 3;
            }
            
            updateUI();
        }

        function nextQuestion() {
            saveCurrentState();
            
            if (currentStep < 3) {
                // Go to next step
                currentStep++;
            } else if (currentIndex < questions.length - 1) {
                // Go to next question, first step
                currentIndex++;
                currentStep = 1;
            } else {
                // Finished all questions
                finishAndSave();
                return;
            }
            
            updateUI();
        }

        function finishAndSave() {
            saveCurrentState();
            saveResultsToFile();
        }

        function saveResultsToFile() {
            const finalResults = Object.values(results);
            
            // Save to Firebase Firestore
            const timestamp = new Date().toISOString();
            const evaluationId = `evaluation_${timestamp.replace(/[:.]/g, '-')}`;
            
            // Show loading message
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = 'Saving results...';
            successMessage.style.display = 'block';
            
            // Try to save to Firebase first
            saveToFirestore()
                .then(() => {
                    console.log('Results saved to Firebase successfully');
                    showThankYouPage(evaluationId, finalResults);
                })
                .catch((error) => {
                    console.error('Firebase save failed:', error);
                    // Fallback to local save
                    saveLocally(finalResults, evaluationId);
                });
            
            function saveToFirestore() {
                return new Promise((resolve, reject) => {
                    // Check if we can write to Firestore
                    if (!auth.currentUser) {
                        console.log('No authenticated user, trying to sign in...');
                        auth.signInAnonymously()
                            .then(() => {
                                console.log('Signed in successfully, now saving...');
                                performFirestoreSave();
                            })
                            .catch((error) => {
                                console.error('Authentication failed:', error);
                                reject(new Error('Authentication failed'));
                            });
                    } else {
                        console.log('User already authenticated, saving...');
                        performFirestoreSave();
                    }
                    
                    function performFirestoreSave() {
                        console.log('Attempting to write to Firestore...');
                        console.log('Collection: evaluations, Document: ' + evaluationId);
                        console.log('Data to save:', {
                            timestamp: timestamp,
                            totalQuestions: questions.length,
                            results: finalResults,
                            metadata: {
                                sampleFraction: SAMPLE_FRACTION,
                                manualFile: MANUAL_FILE,
                                modelFile: MODEL_FILE
                            }
                        });
                        
                        db.collection('evaluations').doc(evaluationId).set({
                            timestamp: timestamp,
                            totalQuestions: questions.length,
                            results: finalResults,
                            metadata: {
                                sampleFraction: SAMPLE_FRACTION,
                                manualFile: MANUAL_FILE,
                                modelFile: MODEL_FILE
                            }
                        })
                        .then(() => {
                            console.log('Firestore write successful!');
                            resolve();
                        })
                        .catch((error) => {
                            console.error('Firestore write failed with error:', error);
                            console.error('Error code:', error.code);
                            console.error('Error message:', error.message);
                            reject(error);
                        });
                    }
                });
            }
            
            function saveLocally(results, evaluationId) {
                // Create a downloadable version as fallback
                const dataStr = JSON.stringify(results, null, 4);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `evaluation_results_${evaluationId}.json`;
                link.click();
                
                // Show thank you page with local save message
                showThankYouPage(evaluationId, results, true);
                
                // Show info message
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Results saved locally. Firebase authentication failed.';
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#d1ecf1';
                errorMessage.style.color = '#0c5460';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        }

        function handleNotMentionedChange(type, index) {
            const notMentionedCheckbox = document.querySelector(`input[name="correctness_${type}_${index}_not_mentioned"]`);
            const row = document.getElementById(`eval_row_${type}_${index}`);
            const correctCheckbox = document.querySelector(`input[name="correctness_${type}_${index}_correct"]`);
            
            if (notMentionedCheckbox.checked) {
                // If "Not Mentioned" is checked, fade out the row and uncheck other options
                row.classList.add('faded');
                if (correctCheckbox) correctCheckbox.checked = false;
            } else {
                // If "Not Mentioned" is unchecked, restore the row
                row.classList.remove('faded');
            }
        }

        function toggleNotMentioned(type, index) {
            const notMentionedInput = document.querySelector(`input[name="correctness_${type}_${index}_not_mentioned"]`);
            const notMentionedBtn = document.getElementById(`not_mentioned_btn_${type}_${index}`);
            const row = document.getElementById(`eval_row_${type}_${index}`);
            const correctCheckbox = document.querySelector(`input[name="correctness_${type}_${index}_correct"]`);
            
            // Toggle the state
            const isNotMentioned = notMentionedInput.value === 'true';
            
            if (!isNotMentioned) {
                // Activate "Not Mentioned" state
                notMentionedInput.value = 'true';
                notMentionedBtn.classList.add('active');
                row.classList.add('faded');
                if (correctCheckbox) correctCheckbox.checked = false;
            } else {
                // Deactivate "Not Mentioned" state
                notMentionedInput.value = 'false';
                notMentionedBtn.classList.remove('active');
                row.classList.remove('faded');
            }
        }

        function restartEvaluation() {
            // Reset all state
            currentIndex = 0;
            currentStep = 1;
            results = {};
            
            // Hide thank you page
            document.getElementById('thankYouPage').style.display = 'none';
            
            // Show main content and sidebar
            document.getElementById('mainContent').style.display = 'block';
            document.querySelector('.sidebar').style.display = 'block';
            
            // Reload data and update UI
            loadAndPrepareData();
        }

        function showThankYouPage(evaluationId, results, isLocalSave = false) {
            // Hide main content and sidebar
            document.getElementById('mainContent').style.display = 'none';
            document.querySelector('.sidebar').style.display = 'none';
            
            // Show thank you page
            const thankYouPage = document.getElementById('thankYouPage');
            thankYouPage.style.display = 'block';
            
            // Set evaluation ID
            document.getElementById('evaluationIdSpan').textContent = evaluationId;
            
            // Update title if it's a local save
            if (isLocalSave) {
                document.querySelector('#thankYouPage h1').textContent = '🎉 Thank You! (Local Save)';
                document.querySelector('#thankYouPage h2').textContent = 'Your evaluation has been saved locally';
            }
            
            // Calculate and display statistics
            const statsGrid = document.getElementById('statsGrid');
            const totalQuestions = results.length;
            const totalEvaluations = results.reduce((sum, result) => {
                return sum + (result.covered_essential_ground_truth || 0) + (result.covered_optional_ground_truth || 0);
            }, 0);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalQuestions}</div>
                    <div class="stat-label">Questions Evaluated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalEvaluations}</div>
                    <div class="stat-label">Total Evaluations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${new Date().toLocaleDateString()}</div>
                    <div class="stat-label">Completion Date</div>
                </div>
            `;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html> 